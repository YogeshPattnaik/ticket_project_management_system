name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  EKS_CLUSTER_NAME: task-management-cluster

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth-service, project-service, notification-service, migration-service]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/${{ matrix.service }}/package-lock.json
    
    - name: Install dependencies
      run: |
        cd backend/${{ matrix.service }}
        npm ci
    
    - name: Run linter
      run: |
        cd backend/${{ matrix.service }}
        npm run lint
    
    - name: Run tests
      run: |
        cd backend/${{ matrix.service }}
        npm run test:cov || true

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [auth-service, project-service, notification-service, migration-service]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/task-system/${{ matrix.service }}:$IMAGE_TAG backend/${{ matrix.service }}
        docker push $ECR_REGISTRY/task-system/${{ matrix.service }}:$IMAGE_TAG
        docker tag $ECR_REGISTRY/task-system/${{ matrix.service }}:$IMAGE_TAG $ECR_REGISTRY/task-system/${{ matrix.service }}:latest
        docker push $ECR_REGISTRY/task-system/${{ matrix.service }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Configure kubectl
      run: |
        aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
    
    - name: Deploy to EKS
      run: |
        IMAGE_TAG=${{ github.sha }}
        ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
        
        for service in auth-service project-service notification-service migration-service; do
          kubectl set image deployment/$service \
            $service=$ECR_REGISTRY/task-system/$service:$IMAGE_TAG \
            --record
        done
    
    - name: Run migrations
      run: |
        kubectl exec -it deployment/migration-service -- npm run migrate:up || true

